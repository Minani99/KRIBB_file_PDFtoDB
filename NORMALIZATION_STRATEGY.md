# 정규화 전략 (Normalization Strategy)

## 🎯 목표: 정확도 우선

매칭률을 높이는 것보다 **부정확한 매칭을 방지**하는 것이 우선입니다.

---

## 📋 정규화 레벨

### 1. 보수적 정규화 (Conservative) - 매칭용

**함수**: `normalize_for_matching()`

**목적**: 실제 매칭에 사용. 의미를 바꾸지 않는 최소한의 정규화만 수행.

**적용 규칙**:
```python
1. 괄호 내용 제거
   "바이오기술(R&D)" → "바이오기술"
   
2. 공백/특수문자 통일 (제거가 아닌 통일)
   "차세대 바이오-매스" → "차세대바이오매스"
   
3. 영문 대소문자 통일
   "COVID-19" → "COVID19"
   
4. "사업" 접미사만 제거 (끝에 있을 때)
   "바이오기술개발사업" → "바이오기술개발"
   "바이오기술개발연구" → "바이오기술개발연구" (그대로)
```

**중요**: 다른 접미사(연구, 개발, 지원 등)는 제거하지 않음!
- "바이오기술개발" ≠ "바이오기술연구" (다른 사업)
- "기술지원" ≠ "기술개발" (다른 사업)

---

### 2. 공격적 정규화 (Aggressive) - 키워드 추출용

**함수**: `normalize_aggressive()`

**목적**: 키워드 추출 및 부분 매칭용. 매칭 판단에는 사용 안 함.

**적용 규칙**:
```python
1. 모든 특수문자/공백 제거
2. 여러 접미사 제거 (사업, 과제, 프로젝트, 연구, 개발, 지원, 육성, 추진, 활성화, 강화, 구축, 조성)
3. 긴 키워드(7자 이상)만 사용
```

**사용처**:
- `search_by_high_confidence_partial()`에서 키워드 추출
- 검색 후보 좁히기 (실제 매칭은 보수적 정규화로 재검증)

---

## ⚖️ 비교: 이전 vs 개선

### ❌ 이전 (문제점)

```python
def normalize_for_search(text):
    text = re.sub(r'[·•\-\.\,\'\"\:\;\!\?\~\s]+', '', text)  # 모든 특수문자 제거
    text = re.sub(r'(사업|과제|프로젝트|연구|개발|지원|육성|추진|활성화|강화)$', '', text)
    return text
```

**문제**:
- "바이오기술개발사업" → "바이오기술" (너무 많이 제거)
- "바이오기술개발연구" → "바이오기술" (다른 사업인데 같아짐!)
- "기술지원사업" → "기술" (의미 손실)
- False Positive (부정확한 매칭) 다량 발생

### ✅ 개선 (정확도 우선)

```python
def normalize_for_matching(text):
    text = re.sub(r'\([^)]*\)', '', text)  # 괄호만
    text = re.sub(r'[\s\-_·•]+', '', text)  # 공백/하이픈/중점만
    text = re.sub(r'[\.,:;!?~]+', '', text)  # 구두점만
    text = text.upper()
    if text.endswith('사업'):  # "사업"만 제거
        text = text[:-2]
    return text
```

**개선점**:
- "바이오기술개발사업" → "바이오기술개발" (의미 보존)
- "바이오기술개발연구" → "바이오기술개발연구" (구분 유지)
- "기술지원사업" → "기술지원" (의미 보존)
- False Positive 최소화

---

## 🎯 매칭 전략

### 1단계: 정확한 매칭 (EXACT_BIZ_MATCH)

```python
보수적_정규화(원본) == 보수적_정규화(DB)
```

**예시**:
```
원본: "바이오기술 개발 사업"
DB:   "바이오기술개발사업"
→ 정규화 후 둘 다 "바이오기술개발" (매칭 ✅)

원본: "바이오기술개발사업"
DB:   "바이오기술개발연구"
→ 정규화 후 "바이오기술개발" vs "바이오기술개발연구" (불일치 ❌)
```

### 2단계: 고신뢰도 부분 매칭 (HIGH_CONF_PARTIAL)

**조건**:
1. 7자 이상 긴 키워드로만 검색
2. 길이 유사도 70~140% 범위
3. 신뢰도 점수 0.5 이상

**예시**:
```
원본: "생명공학핵심기술개발"
→ 키워드: "생명공학핵심기술개발" (14자, 충분히 긴 키워드)
→ DB 검색: LIKE '%생명공학핵심기술개발%'
→ 매칭 후 신뢰도 계산으로 재검증
```

---

## 📊 신뢰도 점수 시스템

```python
score = 0.0

# BIZ_NM 완전 일치
if normalize_for_matching(원본) == normalize_for_matching(DB):
    score += 0.5

# BIZ_NM 포함 관계
elif 포함관계 and 길이유사도 > 0.8:
    score += 0.4

# DETAIL_BIZ_NM 완전 일치
if normalize_for_matching(원본detail) == normalize_for_matching(DBdetail):
    score += 0.3

# 키워드 매칭 페널티
if method == 'HIGH_CONF_PARTIAL' and len(keyword) < 7:
    score *= 0.8

return min(score, 1.0)
```

**점수 기준**:
- **0.7 이상**: 고신뢰도 (자동 매칭 권장)
- **0.5~0.7**: 중신뢰도 (수동 검토 필요)
- **0.5 미만**: 저신뢰도 (사용 비권장)

---

## 🚀 실행 결과 (예상)

### 이전 (부정확)
```
총 매칭 발견: 1,249건
→ False Positive 다수 포함
→ 자동 적용 불가
```

### 개선 후 (정확)
```
고신뢰도 (0.7+): 70건 ← ✅ 자동 매칭 가능
중신뢰도 (0.5~0.7): 68건 ← 수동 검토
저신뢰도 (0.5-): 0건 ← 부정확한 매칭 차단됨
```

---

## 💡 핵심 원칙

1. **보수적 정규화 우선**: 의미를 바꾸지 않는 최소한의 변환만
2. **"사업"만 제거**: 다른 접미사는 의미가 있음
3. **공격적 정규화는 키워드용**: 실제 매칭 판단에는 사용 금지
4. **신뢰도 점수로 검증**: 모든 매칭은 점수로 필터링
5. **정확도 > 매칭률**: 틀린 매칭보다 놓치는 게 나음

---

## 📝 사용 예시

```python
from search_unmatched_in_db import normalize_for_matching

# 매칭 판단
source = "차세대 바이오 매스 기술개발사업"
target = "차세대바이오매스기술개발사업"

if normalize_for_matching(source) == normalize_for_matching(target):
    print("매칭 ✅")
    # 결과: "차세대바이오매스기술개발" == "차세대바이오매스기술개발"
```

---

## 🔍 테스트 케이스

| 원본 | DB | 정규화 결과 | 매칭 |
|------|----|-----------| ----|
| 바이오기술개발사업 | 바이오기술개발사업 | 둘 다 "바이오기술개발" | ✅ |
| 바이오기술개발사업 | 바이오기술개발연구 | "바이오기술개발" vs "바이오기술개발연구" | ❌ (정확!) |
| 차세대 바이오-매스 | 차세대바이오매스 | 둘 다 "차세대바이오매스" | ✅ |
| COVID-19진단기술 | COVID19진단기술 | 둘 다 "COVID19진단기술" | ✅ |
| 기술지원사업 | 기술개발사업 | "기술지원" vs "기술개발" | ❌ (정확!) |

---

**작성일**: 2025-01-20  
**버전**: 2.0 (정확도 우선)

